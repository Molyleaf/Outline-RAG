<!doctype html>
<html lang="zh">
<head>
	<meta charset="utf-8" />
	<title>Outline RAG Chat</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="stylesheet" href="/chat/static/style.css" />
	<script>
        // 主题初始化：localStorage 优先，其次系统偏好
        (function () {
            try {
                const saved = localStorage.getItem('theme'); // 'light' | 'dark' | 'system' | null
                const root = document.documentElement;
                if (saved === 'light' || saved === 'dark') {
                    root.setAttribute('data-theme', saved);
                } else {
                    root.setAttribute('data-theme', 'system');
                }
            } catch (e) {}
        })();
	</script>
</head>
<body>
<div class="app">
	<div class="sidebar">
		<div class="titlebar">
			<strong>对话</strong>
			<button class="btn" id="newConv">新建</button>
		</div>
		<div id="convs"></div>
	</div>
	<div class="main">
		<div class="topbar">
			<div class="actions">
				<label class="upload">
					<input type="file" id="fileInput" style="display:none" />
					<span class="btn tonal">上传附件</span>
				</label>
			</div>
			<div class="menu" id="menu">
				<div class="menu-section">
					<div class="menu-label">主题</div>
					<div class="menu-radio" data-theme="system">系统</div>
					<div class="menu-radio" data-theme="light">浅色</div>
					<div class="menu-radio" data-theme="dark">深色</div>
				</div>
				<div class="menu-divider"></div>
				<a href="/logout">登出</a>
				<a id="refreshAll" href="#">手动刷新 Outline</a>
			</div>
			<div class="avatar" id="avatar" title="菜单"></div>
		</div>
		<div class="chat" id="chat"></div>
		<div class="input">
			<textarea id="q" placeholder="向知识库提问... (Shift+Enter 换行)"></textarea>
			<button class="btn" id="send">发送</button>
			<!-- 移除/隐藏流式开关：始终开启流式 -->
			<label class="switch" style="display:none">
				<input type="checkbox" id="streamToggle" checked />
				<span>流式</span>
			</label>
		</div>
	</div>
</div>
<script src="/chat/static/script.js"></script>
<script>
    // 新建对话行为：与 ChatGPT 一致
    (function () {
        const btn = document.getElementById('newConv');
        if (!btn) return;
        let creating = false;
        btn.addEventListener('click', async () => {
            // 若当前就在 /chat 页面且没有具体会话 GUID，则首次点击创建；创建后跳转到 /chat/<GUID>
            if (creating) return; // 防止重复点击
            // 若当前路径是 /chat/<guid>，继续点击“新建”也要创建并跳转到新的 /chat/<GUID>
            creating = true;
            try {
                const r = await fetch('/chat/api/conversations', {method:'POST', headers:{'Content-Type':'application/json'}});
                if (!r.ok) return;
                const data = await r.json();
                if (data && data.url) {
                    // 和 ChatGPT 一样：跳转到包含 GUID 的 URL
                    location.href = data.url;
                }
            } finally {
                // 创建完成后，进一步点击“新建”应再次创建新会话（非禁用），
                // 但在尚未返回之前的重复点击应无效
                creating = false;
            }
        });
    })();

    // 根据 URL 中的 GUID 作为当前会话
    (function () {
        const path = location.pathname.replace(/\/+$/,'');
        const m = path.match(/^\/chat\/(\w[\w-]*)$/);
        const currentGuid = m ? m[1] : null;
        // 页面可根据 currentGuid 拉取消息列表
        window.__CURRENT_CONV_ID__ = currentGuid; // 供 script.js 使用
    })();

    // 主题切换逻辑保持不变
    (function () {
        const root = document.documentElement;
        const radios = document.querySelectorAll('#menu .menu-radio');
        function renderActive() {
            const mode = root.getAttribute('data-theme') || 'system';
            radios.forEach(el => {
                if (el.getAttribute('data-theme') === mode) el.classList.add('active');
                else el.classList.remove('active');
            });
        }
        radios.forEach(el => {
            el.addEventListener('click', () => {
                const mode = el.getAttribute('data-theme');
                if (mode === 'light' || mode === 'dark') {
                    root.setAttribute('data-theme', mode);
                    localStorage.setItem('theme', mode);
                } else {
                    root.setAttribute('data-theme', 'system');
                    localStorage.setItem('theme', 'system');
                }
                renderActive();
            });
        });
        renderActive();

        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        mql.addEventListener?.('change', () => {
            const saved = localStorage.getItem('theme') || 'system';
            if (saved === 'system') {
                root.setAttribute('data-theme', 'system');
            }
        });
    })();
</script>
</body>
</html>
