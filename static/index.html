<!doctype html>
<html lang="zh">
<head>
	<meta charset="utf-8" />
	<title>Outline RAG Chat</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!-- Material 风格样式 -->
	<link rel="stylesheet" href="/chat/static/style.css" />
	<!-- Shoelace（Material-like 组件：弹窗/按钮/alert） -->
	<script type="module" src="https://unpkg.shop.jd.com/@shoelace-style/shoelace/cdn/shoelace-autoloader.js"></script>
	<link rel="stylesheet" href="https://unpkg.shop.jd.com/@shoelace-style/shoelace/cdn/themes/light.css" />
	<!-- Markdown & 代码高亮 -->
	<script src="https://jsd.onmicrosoft.cn/npm/marked/marked.min.js"></script>
	<!-- 替换为浏览器用的完整 UMD 版 -->
	<script src="https://jsd.onmicrosoft.cn/npm/highlight.js/highlight.min.js"></script>
	<link rel="stylesheet" href="https://jsd.onmicrosoft.cn/npm/highlight.js/styles/github.min.css">
	<script>
        // 主题初始化：localStorage 优先，其次系统偏好
        (function () {
            try {
                const saved = localStorage.getItem('theme'); // 'light' | 'dark' | 'system' | null
                const root = document.documentElement;
                if (saved === 'light' || saved === 'dark') {
                    root.setAttribute('data-theme', saved);
                } else {
                    root.setAttribute('data-theme', 'system');
                }
            } catch (e) {}
        })();
	</script>
</head>
<body>
<div class="app">
	<div class="sidebar">
		<div class="titlebar">
			<strong>对话</strong>
			<button class="btn" id="newConv">新建</button>
		</div>
		<div id="convs"></div>
	</div>
	<div class="sidebar-veil"></div>
	<div class="main">
		<div class="topbar">
			<div class="hamburger">
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
			</div>
			<div class="actions">
				<label class="upload">
					<input type="file" id="fileInput" style="display:none" />
					<span class="btn tonal">上传附件</span>
				</label>
			</div>
			<div class="menu" id="menu">
				<div class="menu-section">
					<div class="menu-label">主题</div>
					<div class="menu-radio" data-theme="system">系统</div>
					<div class="menu-radio" data-theme="light">浅色</div>
					<div class="menu-radio" data-theme="dark">深色</div>
				</div>
				<div class="menu-divider"></div>
				<a href="/logout">登出</a>
				<a id="refreshAll" href="#">手动刷新 Outline</a>
			</div>
			<div class="avatar" id="avatar" title="菜单"></div>
		</div>
		<div class="chat" id="chat"></div>
		<div class="input">
			<textarea id="q" placeholder="向知识库提问... (Shift+Enter 换行)"></textarea>
			<button class="btn" id="send">发送</button>
			<!-- 流式开关隐藏，始终流式 -->
			<label class="switch" style="display:none">
				<input type="checkbox" id="streamToggle" checked />
				<span>流式</span>
			</label>
		</div>
	</div>
</div>

<script src="/chat/static/script.js"></script>
<script>
    // 新建会话
    (function () {
        const btn = document.getElementById('newConv');
        if (!btn) return;
        let creating = false;
        btn.addEventListener('click', async () => {
            if (creating) return;
            creating = true;
            try {
                const r = await fetch('/chat/api/conversations', {method:'POST', headers:{'Content-Type':'application/json'}});
                if (!r.ok) return;
                const data = await r.json();
                if (data && data.url) location.href = data.url;
            } finally {
                creating = false;
            }
        });
    })();

    // 主题切换
    (function () {
        const root = document.documentElement;
        const radios = document.querySelectorAll('#menu .menu-radio');
        function renderActive() {
            const mode = root.getAttribute('data-theme') || 'system';
            radios.forEach(el => {
                if (el.getAttribute('data-theme') === mode) el.classList.add('active');
                else el.classList.remove('active');
            });
        }
        radios.forEach(el => {
            el.addEventListener('click', () => {
                const mode = el.getAttribute('data-theme');
                if (mode === 'light' || mode === 'dark') {
                    root.setAttribute('data-theme', mode);
                    localStorage.setItem('theme', mode);
                } else {
                    root.setAttribute('data-theme', 'system');
                    localStorage.setItem('theme', 'system');
                }
                renderActive();
            });
        });
        renderActive();
        const mql = window.matchMedia('(prefers-color-scheme: dark)');
        mql.addEventListener?.('change', () => {
            const saved = localStorage.getItem('theme') || 'system';
            if (saved === 'system') root.setAttribute('data-theme', 'system');
        });
    })();

    // 移动端侧边栏
    (function () {
        const app = document.querySelector('.app');
        const hamburger = document.querySelector('.hamburger');
        const veil = document.querySelector('.sidebar-veil');
        if (!app || !hamburger || !veil) return;
        hamburger.addEventListener('click', () => app.classList.toggle('sidebar-open'));
        veil.addEventListener('click', () => app.classList.remove('sidebar-open'));
    })();
</script>
</body>
</html>