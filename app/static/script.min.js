const avatar=document.getElementById("avatar"),menu=document.getElementById("menu"),chatEl=document.getElementById("chat"),convsEl=document.getElementById("convs"),newConvBtn=document.getElementById("newConv"),sendBtn=document.getElementById("send"),qEl=document.getElementById("q"),refreshAll=document.getElementById("refreshAll"),fileInput=document.getElementById("fileInput"),appRoot=document.querySelector(".app"),hamburger=document.querySelector(".topbar .hamburger"),sidebarVeil=document.querySelector(".sidebar-veil");let INPUT_MAX_PX=Math.floor(.2*window.innerHeight);const themeRadios=Array.from(document.querySelectorAll(".menu .menu-radio")),mobileSheetOverlay=document.createElement("div");mobileSheetOverlay.className="mobile-sheet-overlay";const mobileSheetPanel=document.createElement("div");mobileSheetPanel.className="mobile-sheet-panel";const mobileSheetHeader=document.createElement("div");mobileSheetHeader.className="mobile-sheet-header";const mobileSheetContent=document.createElement("div");function showMobileSheet(e,t=""){mobileSheetHeader.textContent=t,mobileSheetHeader.style.display=t?"block":"none",mobileSheetContent.innerHTML=e,mobileSheetOverlay.classList.add("visible"),mobileSheetPanel.classList.add("visible")}function hideMobileSheet(){mobileSheetOverlay.classList.remove("visible"),mobileSheetPanel.classList.remove("visible")}mobileSheetContent.className="mobile-sheet-content",mobileSheetPanel.append(mobileSheetHeader,mobileSheetContent),document.body.append(mobileSheetOverlay,mobileSheetPanel),mobileSheetOverlay.addEventListener("click",hideMobileSheet);const MODELS={"deepseek-ai/DeepSeek-V3.2-Exp":{name:"Deepseek",icon:"/chat/static/img/DeepSeek.svg",temp:.7,top_p:.7},"moonshotai/Kimi-K2-Instruct-0905":{name:"Kimi K2",icon:"/chat/static/img/moonshotai_new.png",temp:.6,top_p:.7},"zai-org/GLM-4.6":{name:"ChatGLM",icon:"/chat/static/img/thudm.svg",temp:.6,top_p:.95},"Qwen/Qwen3-Next-80B-A3B-Instruct":{name:"Qwen3-Next",icon:"/chat/static/img/Tongyi.svg",temp:.6,top_p:.95},"inclusionAI/Ling-1T":{name:"Ling-1T",icon:"/chat/static/img/ling.png",temp:.6,top_p:.7}};let currentModelId=localStorage.getItem("chat_model")||Object.keys(MODELS)[0];MODELS[currentModelId]||(currentModelId=Object.keys(MODELS)[0],localStorage.setItem("chat_model",currentModelId));let currentTemperature=MODELS[currentModelId].temp,currentTopP=MODELS[currentModelId].top_p;function getAvatarUrlForModel(e){const t="/chat/static/img/openai.svg";if(!e)return t;const n=(e.split("/")[0]||"").toLowerCase();return"deepseek-ai"===n?"/chat/static/img/DeepSeek.svg":"qwen"===n?"/chat/static/img/Tongyi.svg":"moonshotai"===n?"/chat/static/img/moonshotai_new.png":"zai-org"===n||"thudm"===n?"/chat/static/img/thudm.svg":"inclusionai"===n?"/chat/static/img/ling.png":t}let currentConvId=null;!function(){const e=location.pathname.replace(/\/+$/,"").match(/^\/chat\/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$/);e&&(currentConvId=e[1])}();let userInfo=null;function toast(e,t="primary",n=3e3){const o=document.createElement("sl-alert");return o.variant=t,o.closable=!0,o.innerHTML=`<sl-icon name="${"success"===t?"check2-circle":"warning"===t?"exclamation-triangle":"danger"===t?"x-octagon":"info-circle"}" slot="icon"></sl-icon>${e}`,document.body.appendChild(o),"function"==typeof o.toast?o.toast():o.setAttribute("open",""),n&&setTimeout((()=>{"function"==typeof o.hide?o.hide():o.remove()}),n),o}function confirmDialog(e,{okText:t="确定",cancelText:n="取消"}={}){return new Promise((o=>{const a=document.createElement("sl-dialog");a.label="请确认",a.innerHTML=`<div style="line-height:1.6">${e}</div>\n        <div slot="footer" style="display:flex;gap:8px;justify-content:flex-end">\n            <sl-button class="cancel" variant="neutral">${n}</sl-button>\n            <sl-button class="ok" variant="primary">${t}</sl-button>\n        </div>`,document.body.appendChild(a);const r=()=>{"function"==typeof a.hide?a.hide():a.removeAttribute("open")};a.addEventListener("sl-after-hide",(()=>a.remove())),a.querySelector(".cancel").addEventListener("click",(()=>{r(),o(!1)})),a.querySelector(".ok").addEventListener("click",(()=>{r(),o(!0)})),"function"==typeof a.show?a.show():a.setAttribute("open","")}))}function promptDialog(e,t="",{okText:n="确定",cancelText:o="取消",placeholder:a=""}={}){return new Promise((r=>{const i=document.createElement("sl-dialog");i.label=e||"输入",i.innerHTML=`\n          <sl-input value="${t.replace(/"/g,"&quot;")}" placeholder="${a.replace(/"/g,"&quot;")}"></sl-input>\n          <div slot="footer" style="display:flex;gap:8px;justify-content:flex-end">\n            <sl-button class="cancel" variant="neutral">${o}</sl-button>\n            <sl-button class="ok" variant="primary">${n}</sl-button>\n          </div>`,document.body.appendChild(i);const s=i.querySelector("sl-input");function l(e){"function"==typeof i.hide?i.hide():i.removeAttribute("open"),r(e)}i.addEventListener("sl-after-hide",(()=>i.remove())),i.querySelector(".cancel").addEventListener("click",(()=>l(null))),i.querySelector(".ok").addEventListener("click",(()=>l(s.value.trim()))),i.addEventListener("sl-initial-focus",(()=>s.focus())),"function"==typeof i.show?i.show():i.setAttribute("open","")}))}function renderMarkdown(e){if(!window.marked){const t=document.createElement("pre");return t.textContent=e||"",t}const t=window.marked.parse||window.marked.default?.parse;if("function"!=typeof t){const t=document.createElement("pre");return t.textContent=e||"(Markdown 渲染器加载中...)",t}const n=t(e||"",{breaks:!0,gfm:!0}),o=document.createElement("div");return o.className="md-body",o.removeAttribute("style"),o.innerHTML=n,window.hljs&&o.querySelectorAll("pre code").forEach((e=>window.hljs.highlightElement(e))),o}function animateIn(e){e.animate([{transform:"translateY(6px)",opacity:0},{transform:"translateY(0)",opacity:1}],{duration:160,easing:"cubic-bezier(.2,.8,.2,1)"})}async function api(e,t){const n={credentials:"include",...t||{}};n.headers={"Content-Type":"application/json",...t&&t.headers||{}};const o=await fetch(e,n);if(401===o.status)return window.location="/chat/login",null;if(t&&t.stream||o.headers.get("content-type")?.includes("text/event-stream"))return o;try{return await o.json()}catch{return{httpOk:o.ok}}}async function loadUser(){const e=await api("/chat/api/me");if(!e)return;userInfo=e,avatar.style.backgroundImage=`url('${e.avatar_url||""}')`;const t=document.querySelector("#greeting .greet-title");if(t){const n=(e.name||e.username||"").trim();t.textContent=n?`你好，${n}！`:"你好！"}}function toSameOriginUrl(e){if(e?.url)try{const t=new URL(e.url,location.origin);if(t.origin===location.origin&&t.pathname.startsWith("/chat/"))return t.href}catch(e){}return e?.id?`${location.origin}/chat/${e.id}`:null}async function loadConvs(){if(!userInfo)try{await loadUser()}catch(e){}const e=await api("/chat/api/conversations");convsEl.innerHTML="";(e?.items||[]).forEach((e=>{const t=document.createElement("div");t.className="conv"+(String(e.id)===String(currentConvId)?" active":""),t.tabIndex=0,t.dataset.id=e.id;const n=document.createElement("span");n.className="conv-title",n.textContent=e.title||"会话 "+(e.id||"").slice(0,8);const o=document.createElement("button");o.className="conv-menu",o.textContent="⋯";const a=document.createElement("div");a.className="conv-menu-pop";const r=document.createElement("div");r.textContent="重命名";const i=document.createElement("div");i.textContent="删除",t.addEventListener("click",(n=>{if(o.contains(n.target)||a.contains(n.target))return;n.preventDefault();const r=toSameOriginUrl(e);if(r&&r!==location.href){currentConvId=e.id;try{history.pushState(null,"",r)}catch(e){return void(location.href=r)}chatEl.innerHTML="",document.getElementById("greeting")?.remove(),loadMessages(),document.querySelectorAll(".conv.active").forEach((e=>e.classList.remove("active"))),t.classList.add("active")}})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),t.click())})),o.onclick=e=>{e.stopPropagation(),a.classList.toggle("visible")},r.onclick=async t=>{t.stopPropagation();const o=await promptDialog("重命名会话",n.textContent,{placeholder:"请输入新标题"});if(null==o)return void a.classList.remove("visible");const r=o.trim();if(!r)return void toast("标题不能为空","warning");const i=await api(`/chat/api/conversations/${e.id}/rename`,{method:"POST",body:JSON.stringify({title:r})});i&&(!0===i.ok||"ok"===i.status||!0===i.httpOk)?(await loadConvs(),toast("已重命名","success")):toast(i?.error||"重命名失败","danger"),a.classList.remove("visible")},i.onclick=async t=>{t.stopPropagation();if(!await confirmDialog("确定删除该会话？此操作不可恢复。",{okText:"删除",cancelText:"取消"}))return void a.classList.remove("visible");const n=await api(`/chat/api/conversations/${e.id}/delete`,{method:"POST"});if(n&&(!0===n.ok||"ok"===n.status||!0===n.httpOk)){if(String(currentConvId)===String(e.id)){currentConvId=null,chatEl.innerHTML="";try{history.replaceState(null,"","/chat")}catch(e){return void(location.href="/chat")}document.getElementById("greeting")?.remove(),loadMessages()}await loadConvs(),toast("已删除","success")}else toast(n?.error||"删除失败","danger");a.classList.remove("visible")},a.appendChild(r),a.appendChild(i),document.__convMenuCloserBound__||(document.addEventListener("click",(e=>{document.querySelectorAll(".conv-menu-pop").forEach((t=>{const n=t.parentElement,o=n?.querySelector(".conv-menu");t.classList.contains("visible")&&!t.contains(e.target)&&e.target!==o&&t.classList.remove("visible")}))})),document.__convMenuCloserBound__=!0),t.appendChild(n),t.appendChild(o),t.appendChild(a);let s=null;t.addEventListener("touchstart",(e=>{window.innerWidth>960||null!==o.offsetParent||(s=setTimeout((async()=>{s=null,e.preventDefault();showMobileSheet('\n                    <div class="mobile-menu-item" data-action="rename">重命名</div>\n                    <div class="mobile-menu-item danger" data-action="delete">删除对话</div>\n                ',"对话选项");const t=mobileSheetContent.querySelector('[data-action="rename"]'),n=mobileSheetContent.querySelector('[data-action="delete"]');t&&(t.onclick=()=>{hideMobileSheet(),r.onclick(new Event("click",{bubbles:!1}))}),n&&(n.onclick=()=>{hideMobileSheet(),i.onclick(new Event("click",{bubbles:!1}))})}),500))}),{passive:!1});const l=()=>{s&&clearTimeout(s),s=null};t.addEventListener("touchend",l),t.addEventListener("touchmove",l),convsEl.appendChild(t),animateIn(t)}))}async function loadMessages(){if(chatEl.innerHTML="",document.getElementById("greeting")?.remove(),!currentConvId){let e=document.getElementById("greeting");e||(e=document.createElement("div"),e.id="greeting",e.className="greeting",e.innerHTML='\n                 <div class="greet-title">你好！</div>\n                 <div class="greet-sub">随时提问，或从以下示例开始</div>\n                 <div class="greet-suggestions">\n                     <button class="chip">总结新手教程</button>\n                     <button class="chip">拉汶帝国完蛋了吗</button>\n                     <button class="chip">开发组的烂摊子怎么样了</button>\n                 </div>\n             ',chatEl.appendChild(e),e.querySelectorAll(".greet-suggestions .chip").forEach((e=>{e.addEventListener("click",(()=>{qEl.value=e.textContent.trim(),qEl.focus()}))})));const t=e.querySelector(".greet-title");if(t){const e=(userInfo?.name||userInfo?.username||"").trim();t.textContent=e?`你好，${e}！`:"你好！"}return void(e.style.display="block")}const e=await api("/chat/api/messages?conv_id="+currentConvId);(e?.items||[]).forEach((e=>appendMsg(e.role,e.content,e))),chatEl.scrollTop=chatEl.scrollHeight}function appendMsg(e,t,n={}){const o=document.createElement("div");o.className="msg "+e;const a=document.createElement("div");if(a.className="avatar","assistant"===e){const e=getAvatarUrlForModel(n.model);a.style.backgroundImage=`url('${e}')`}else a.style.display="none";const r=document.createElement("div");r.className="bubble";const i=document.createElement("div");i.className="bubble-inner";const s=renderMarkdown(String(t??""));if(i.appendChild(s),r.appendChild(i),"assistant"===e&&(n.model||void 0!==n.temperature)){const e=document.createElement("div");e.className="msg-meta";const t=(MODELS[n.model]||{}).name||(n.model||"N/A").split("/")[1],o="number"==typeof n.temperature?n.temperature.toFixed(2):"N/A",a="number"==typeof n.top_p?n.top_p.toFixed(2):"N/A",i=n.created_at?new Date(n.created_at).toLocaleString():"";let s=`模型: ${t} · Temp: ${o} · Top-P: ${a}`;i&&(s+=` · ${i}`),e.textContent=s,r.appendChild(e)}return"user"===e||o.appendChild(a),o.appendChild(r),chatEl.appendChild(o),animateIn(o),chatEl.scrollTop=chatEl.scrollHeight,o}async function sendQuestion(){const e=qEl.value.trim();if(!e)return;const t=document.getElementById("greeting");t&&(t.style.display="none"),qEl.value="";const n=new Event("input");if(qEl.dispatchEvent(n),!currentConvId){const t=await api("/chat/api/conversations",{method:"POST",body:JSON.stringify({title:e.slice(0,30)||"新会话"})}),n=t?.id,o=t?.url&&t.url.startsWith("/")?t.url:n?"/chat/"+n:null;if(!n||!o)return void toast("创建会话失败","danger");currentConvId=n;try{history.replaceState(null,"",o)}catch(e){return void(location.href=o)}try{await loadConvs()}catch(e){}}appendMsg("user",e),qEl.value="";const o=appendMsg("assistant","",{model:currentModelId,temperature:currentTemperature,top_p:currentTopP});let a=o.querySelector(".md-body");if(!a){const e=o.querySelector(".bubble-inner")||o.querySelector(".bubble")||o,t=document.createElement("div");t.className="md-body",e.appendChild(t),a=t}a.innerHTML="",a.classList.add("streaming");let r="";const i=(e=!1)=>{const t=window.marked.parse||window.marked.default?.parse;t?a.innerHTML=t(r,{breaks:!0,gfm:!0}):a.textContent=r,e&&window.hljs&&(a.classList.remove("streaming"),a.querySelectorAll("pre code").forEach((e=>{try{window.hljs.highlightElement(e)}catch(e){console.error("Highlight.js error:",e)}}))),chatEl.scrollTop=chatEl.scrollHeight},s=await fetch("/chat/api/ask",{method:"POST",body:JSON.stringify({conv_id:currentConvId,query:e,model:currentModelId,temperature:currentTemperature,top_p:currentTopP}),headers:{"Content-Type":"application/json"},credentials:"include"});if(!s.ok)return a.textContent="请求失败",a.classList.remove("streaming"),void toast("请求失败","danger");const l=s.body.getReader(),c=new TextDecoder;let d="",m=!1;try{for(;;){const{value:e,done:t}=await l.read();if(t)break;let n;for(d+=c.decode(e,{stream:!0});(n=d.indexOf("\n\n"))>=0;){const e=d.slice(0,n).trim();if(d=d.slice(n+2),e.startsWith("data:")){const t=e.slice(5).trim();if("[DONE]"===t)return void i(!0);try{const e=JSON.parse(t);if(!m&&e.model){const t=getAvatarUrlForModel(e.model),n=o.querySelector(".avatar");n&&(n.style.backgroundImage=`url('${t}')`),m=!0}const n=e.choices?.[0]?.delta?.content;"string"==typeof n&&n.length>0&&(r+=n,i(!1))}catch{}}}}i(!0)}catch(e){console.error("Stream processing error:",e),i(!0),toast("连接中断","warning")}}avatar.addEventListener("click",(()=>{menu.classList.toggle("visible")})),function(){const e=localStorage.getItem("theme")||"system";function t(){themeRadios.forEach((e=>{e.classList.toggle("active",e.dataset.theme===(localStorage.getItem("theme")||"system"))}))}document.documentElement.setAttribute("data-theme","light"===e||"dark"===e?e:"system"),t(),themeRadios.forEach((e=>{e.addEventListener("click",(n=>{const o=e.dataset.theme;localStorage.setItem("theme",o),document.documentElement.setAttribute("data-theme","light"===o||"dark"===o?o:"system"),t(),toast(`已切换为${"system"===o?"系统":"light"===o?"浅色":"深色"}主题`,"success",1800),menu.classList.remove("visible")}))}))}(),function(){function e(){INPUT_MAX_PX=Math.floor(.2*window.innerHeight),qEl.style.maxHeight=INPUT_MAX_PX+"px"}function t(){qEl.style.height="auto";const e=Math.min(qEl.scrollHeight,INPUT_MAX_PX);qEl.style.height=e+"px",qEl.style.overflowY=qEl.scrollHeight>INPUT_MAX_PX?"auto":"hidden"}e(),t(),qEl.addEventListener("input",t),window.addEventListener("resize",(()=>{e(),t()}))}(),document.addEventListener("click",(e=>{avatar.contains(e.target)||menu.contains(e.target)||menu.classList.remove("visible")})),refreshAll.addEventListener("click",(async e=>{e.preventDefault();const t=await api("/chat/update/all",{method:"POST"});if(t&&t.ok){toast("已开始全量刷新","primary",2500);const e=setInterval((async()=>{const t=await api("/chat/api/refresh/status");t?"success"===t.status?(clearInterval(e),toast(t.message||"全量刷新完成","success",4e3),console.log("全量刷新完成:",t.message)):"error"===t.status&&(clearInterval(e),toast(t.message||"刷新失败","danger"),console.error("全量刷新失败:",t.message)):clearInterval(e)}),3e3)}else t&&t.error?toast(t.error,"warning"):toast("启动刷新失败","danger")})),fileInput.addEventListener("change",(async e=>{const t=e.target.files[0];if(!t)return;const n=new FormData;n.append("file",t);(await fetch("/chat/api/upload",{method:"POST",body:n,credentials:"include"})).ok?toast("上传成功，已加入索引","success"):toast("上传失败","danger"),e.target.value=""})),newConvBtn.addEventListener("click",(async e=>{e.preventDefault(),currentConvId=null,chatEl.innerHTML="";let t=document.getElementById("greeting");t||(t=document.createElement("div"),t.id="greeting",t.className="greeting",t.innerHTML='\n            <div class="greet-title">你好！</div>\n            <div class="greet-sub">随时提问，或从以下示例开始</div>\n            <div class="greet-suggestions">\n                <button class="chip">总结新手教程</button>\n                <button class="chip">拉汶帝国完蛋了吗</button>\n                <button class="chip">开发组的烂摊子怎么样了</button>\n            </div>\n        ',chatEl.appendChild(t),t.querySelectorAll(".greet-suggestions .chip").forEach((e=>{e.addEventListener("click",(()=>{qEl.value=e.textContent.trim(),qEl.focus()}))})));const n=t.querySelector(".greet-title");if(n){const e=(userInfo?.name||userInfo?.username||"").trim();n.textContent=e?`你好，${e}！`:"你好！"}t.style.display="block";try{history.pushState(null,"","/chat")}catch(e){return void(location.href="/chat")}document.querySelectorAll(".conv.active").forEach((e=>e.classList.remove("active"))),window.innerWidth<=960&&appRoot?.classList.remove("sidebar-open")})),window.addEventListener("popstate",(()=>{const e=location.pathname.replace(/\/+$/,"").match(/^\/chat\/([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12})$/);if(currentConvId=e?e[1]:null,chatEl.innerHTML="",document.querySelectorAll(".conv.active").forEach((e=>e.classList.remove("active"))),currentConvId){const e=Array.from(convsEl.querySelectorAll(".conv")).find((e=>e.dataset.id===currentConvId));e&&e.classList.add("active")}const t=document.getElementById("greeting");t&&(t.style.display=currentConvId?"none":"block"),loadMessages()})),sendBtn.addEventListener("click",sendQuestion),qEl.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendQuestion())})),async function(){!function(){const e=document.querySelector(".topbar .actions");if(!e)return;const t=(e,t,n,o)=>`\n            <div class="param-slider">\n                <label><span>${e}</span><input type="number" class="param-input" value="${t}" step="${o}" max="${n}"></label>\n                <input type="range" class="param-range" value="${t}" min="0" max="${n}" step="${o}">\n            </div>`,n=e.querySelector("label.upload"),o=n?n.querySelector("span.btn"):null;function a(e,t){const n=MODELS[e]||{};let o;const a=`alt="${n.name||"Model"}"`;e.includes("moonshotai")?(t.classList.add("moonshot-dark"),o=`<img src="${n.icon||""}" ${a} style="width:38px;height:38px;border-radius:50%;padding: 0;">`):(t.classList.remove("moonshot-dark"),o=`<img src="${n.icon||""}" ${a} style="width:38px;height:38px;border-radius:50%;background-color: white;padding: 3px;">`),t.innerHTML=o}o&&(o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>',o.style.width="40px",o.style.height="40px",o.style.borderRadius="50%",o.style.padding="0",o.style.display="inline-flex",o.style.alignItems="center",o.style.justifyContent="center");const r=document.createElement("button");r.className="btn tonal",a(currentModelId,r);const i=document.createElement("button");i.className="btn tonal",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M12 13.25a3.25 3.25 0 1 0 0-6.5a3.25 3.25 0 0 0 0 6.5M13.5 4.636a.75.75 0 0 1-.75.75a4.75 4.75 0 0 0 0 9.228a.75.75 0 0 1 0 1.5a6.25 6.25 0 0 1 0-12.228a.75.75 0 0 1 .75.75M12 1.25a.75.75 0 0 1 .75.75v.255a.75.75 0 0 1-1.5 0V2a.75.75 0 0 1 .75-.75M12 20.25a.75.75 0 0 1 .75.75v.255a.75.75 0 0 1-1.5 0V21a.75.75 0 0 1 .75-.75m-6.79-2.54a.75.75 0 1 1-1.06-1.06l.176-.177a.75.75 0 0 1 1.06 1.06zm12.52 0a.75.75 0 1 1 1.06 1.06l-.176.177a.75.75 0 0 1-1.06-1.06z"/></svg>',i.title=`Temperature: ${currentTemperature}`;const s=document.createElement("button");s.className="btn tonal",s.innerHTML="<b>P</b>",s.title=`Top-P: ${currentTopP}`,[r,i,s].forEach((e=>{e.style.width="40px",e.style.height="40px",e.style.borderRadius="50%",e.style.padding="0"})),n&&(e.insertBefore(r,n),e.insertBefore(i,n),e.insertBefore(s,n));const l=`\n            <div class="model-menu">${Object.entries(MODELS).map((([e,t])=>`<div class="model-item ${e===currentModelId?"active":""}" data-id="${e}">\n                    <img src="${t.icon}" alt="${t.name}"><span>${t.name}</span>\n                </div>`)).join("")}\n            </div>\n            <div class="popover-divider"></div>\n            ${t("Temperature",currentTemperature,2,.05)}\n            <div class="popover-divider"></div>\n            ${t("Top-P",currentTopP,2,.05)}\n        `;i.style.display="none",s.style.display="none";const c=function(e,n,o){const l=document.createElement("div");return l.className="toolbar-popover",l.innerHTML=n,document.body.appendChild(l),e.addEventListener("click",(n=>{if(n.stopPropagation(),window.innerWidth<=768&&(e===i||e===s||e===r)){showMobileSheet(`\n            <div class="mobile-sheet-group">\n                <div class="mobile-sheet-label">模型</div>\n                <div class="model-menu mobile">\n                    ${Object.entries(MODELS).map((([e,t])=>`<div class="model-item ${e===currentModelId?"active":""}" data-id="${e}">\n                            <img src="${t.icon}" alt="${t.name}"><span>${t.name}</span>\n                        </div>`)).join("")}\n                </div>\n            </div>\n            <div class="mobile-sheet-group">\n                ${t("Temperature",currentTemperature,2,.05)}\n            </div>\n            <div class="mobile-sheet-group">\n                ${t("Top-P",currentTopP,2,.05)}\n            </div>\n        `,"模型设置"),mobileSheetContent.querySelectorAll(".model-item").forEach((e=>{e.addEventListener("click",(()=>{currentModelId=e.dataset.id,localStorage.setItem("chat_model",currentModelId);const t=MODELS[currentModelId];currentTemperature=t.temp,currentTopP=t.top_p,a(currentModelId,r),i.title=`Temperature: ${currentTemperature}`,s.title=`Top-P: ${currentTopP}`,hideMobileSheet()}))}));const e=mobileSheetContent.querySelector(".mobile-sheet-group:nth-of-type(2) .param-slider");e&&d(e,(e=>{currentTemperature=e}),i,"Temperature");const n=mobileSheetContent.querySelector(".mobile-sheet-group:nth-of-type(3) .param-slider");return void(n&&d(n,(e=>{currentTopP=e}),s,"Top-P"))}const c=document.querySelectorAll(".toolbar-popover"),m=l.classList.contains("visible");if(c.forEach((e=>{e.classList.remove("visible")})),!m){const t=e.getBoundingClientRect();l.style.top=t.bottom+8+"px",l.style.left="auto",l.style.right=window.innerWidth-t.right+"px",l.style.transform="",l.classList.add("visible"),o&&o(l)}})),l}(r,l,(e=>{const t=e.querySelectorAll(".param-slider");if(t.length>=2){const e=t[0].querySelector(".param-input"),n=t[0].querySelector(".param-range"),o=t[1].querySelector(".param-input"),a=t[1].querySelector(".param-range");e&&(e.value=currentTemperature.toFixed(2)),n&&(n.value=currentTemperature),o&&(o.value=currentTopP.toFixed(2)),a&&(a.value=currentTopP)}e.querySelectorAll(".model-item").forEach((e=>{e.classList.toggle("active",e.dataset.id===currentModelId)}))}));function d(e,t,n,o){if(!e)return void console.error("setupSlider received null element. This might be a selector error.");const a=e.querySelector(".param-input"),r=e.querySelector(".param-range");if(!a||!r)return void console.error("Slider input or range not found inside",e);const i=e=>{const i=parseFloat(e);isNaN(i)||(t(i),a.value=i.toFixed(2),r.value=i,n.title=`${o}: ${i.toFixed(2)}`)};a.addEventListener("input",(e=>i(e.target.value))),r.addEventListener("input",(e=>i(e.target.value)))}c.querySelectorAll(".model-item").forEach((e=>{e.addEventListener("click",(()=>{currentModelId=e.dataset.id,localStorage.setItem("chat_model",currentModelId);const t=MODELS[currentModelId];currentTemperature=t.temp,currentTopP=t.top_p,a(currentModelId,r),i.title=`Temperature: ${currentTemperature}`,s.title=`Top-P: ${currentTopP}`,c.querySelectorAll(".model-item").forEach((e=>e.classList.remove("active"))),e.classList.add("active"),c.classList.remove("visible")}))}));const m=c.querySelectorAll(".param-slider");m.length>=2&&(d(m[0],(e=>currentTemperature=e),i,"Temperature"),d(m[1],(e=>currentTopP=e),s,"Top-P")),document.addEventListener("click",(()=>{document.querySelectorAll(".toolbar-popover").forEach((e=>e.classList.remove("visible")))}));const u=document.createElement("style");u.innerText="\n            /* (Req 9) 设置菜单动画 */\n            .toolbar-popover { \n                position: fixed; background: var(--panel); border: 1px solid var(--border); \n                border-radius: var(--radius-m); box-shadow: var(--shadow-2); padding: 8px; z-index: 100; \n                visibility: hidden; opacity: 0; transform: scale(0.95) translateY(-10px);\n                transform-origin: top right;\n                transition: visibility 0s .2s, opacity .2s ease, transform .2s ease;\n            }\n            .toolbar-popover.visible {\n                visibility: visible; opacity: 1; transform: scale(1) translateY(0);\n                transition: opacity .2s ease, transform .2s ease;\n            }\n            .model-menu { display: flex; flex-direction: column; gap: 4px; }\n            .model-item { display: flex; align-items: center; gap: 8px; padding: 8px 12px; border-radius: var(--radius-s); cursor: pointer; white-space: nowrap; }\n            .model-item:hover { background: color-mix(in srgb, var(--panel) 70%, var(--bg)); }\n            .model-item.active { \n                background: color-mix(in srgb, var(--accent) 15%, var(--panel));\n                color: var(--accent);\n                font-weight: 600;\n            }\n            .model-item img { width: 24px; height: 24px; border-radius: 4px; }\n            .param-slider { padding: 8px; display: flex; flex-direction: column; gap: 8px; width: 220px; }\n            .param-slider label { display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: var(--muted); }\n            .param-input { width: 60px; border: 1px solid var(--border); background: var(--bg); color: var(--text); border-radius: 6px; padding: 4px 6px; font-size: 14px; }\n            .param-range { width: 100%; accent-color: var(--accent); }\n            /* .msg .bubble .msg-meta { font-size: 0.8rem; color: var(--muted); margin-top: 8px; } */\n            \n            .popover-divider { height: 1px; background: var(--border); margin: 8px 0; }\n\n            /* --- (Req 1, 4) 自定义移动端弹窗样式 --- */\n            .mobile-sheet-overlay {\n                position: fixed;\n                inset: 0;\n                background: rgba(0,0,0,.35);\n                opacity: 0;\n                visibility: hidden;\n                transition: opacity .3s ease, visibility 0s .3s;\n                z-index: 100;\n            }\n            .mobile-sheet-overlay.visible {\n                opacity: 1;\n                visibility: visible;\n                transition: opacity .3s ease;\n            }\n            .mobile-sheet-panel {\n                position: fixed;\n                left: 0;\n                right: 0;\n                bottom: 0;\n                background: var(--panel);\n                border-top: 1px solid var(--border);\n                border-radius: var(--radius-l) var(--radius-l) 0 0;\n                box-shadow: var(--shadow-2);\n                z-index: 101;\n                transform: translateY(100%);\n                transition: transform .3s ease;\n                max-height: 70vh;\n                display: flex;\n                flex-direction: column;\n            }\n            .mobile-sheet-panel.visible {\n                transform: translateY(0);\n            }\n            .mobile-sheet-header {\n                font-size: 14px;\n                font-weight: 600;\n                color: var(--muted);\n                padding: 16px 20px 12px;\n                border-bottom: 1px solid var(--border);\n                text-align: center;\n            }\n            .mobile-sheet-content {\n                overflow-y: auto;\n                padding: 8px;\n            }\n            .mobile-menu-item {\n                padding: 14px 20px;\n                font-size: 16px;\n                cursor: pointer;\n                border-radius: var(--radius-s);\n            }\n            .mobile-menu-item:hover {\n                background: color-mix(in srgb, var(--panel) 70%, var(--bg));\n            }\n            .mobile-menu-item.danger {\n                color: var(--sl-color-danger-600);\n            }\n            .mobile-sheet-group {\n                padding: 8px;\n                border-bottom: 1px solid var(--border);\n            }\n            .mobile-sheet-group:last-child {\n                border-bottom: none;\n            }\n            .mobile-sheet-label {\n                font-size: 13px;\n                font-weight: 600;\n                color: var(--muted);\n                padding: 8px 8px 4px;\n            }\n            .model-menu.mobile {\n                display: grid;\n                grid-template-columns: 1fr 1fr;\n                gap: 8px;\n            }\n            /* 修复 #3: 移动端模型菜单样式 */\n            .model-menu.mobile .model-item {\n                padding: 8px;\n                flex-direction: row; /* 改为 row */\n                align-items: center; /* 垂直居中 */\n                gap: 8px; /* 增加间距 */\n            }\n            .model-menu.mobile .model-item img { width: 32px; height: 32px; }\n            .model-menu.mobile .model-item span { font-size: 14px; }\n        ",document.head.appendChild(u)}(),(async()=>{try{await loadUser()}catch(e){}await loadConvs();const e=document.getElementById("greeting");if(!currentConvId&&e&&(e.style.display="block"),currentConvId)try{await loadMessages()}catch(e){}})()}(),hamburger&&hamburger.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),appRoot?.classList.toggle("sidebar-open")})),sidebarVeil&&sidebarVeil.addEventListener("click",(()=>{appRoot?.classList.remove("sidebar-open")})),convsEl.addEventListener("click",(e=>{const t=e.target.closest(".conv"),n=e.target.closest(".conv-menu"),o=e.target.closest(".conv-menu-pop");t&&!n&&!o&&window.innerWidth<=960&&appRoot?.classList.remove("sidebar-open")}));
//# sourceMappingURL=script.min.js.map